# ==========================
# yeying-rag production image
# ==========================
FROM python:3.11-slim

WORKDIR /app

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONPATH=/app \
    PORT=8001

# ---------- å®‰è£…ç³»ç»Ÿä¾èµ– ----------
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl git ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# ---------- æ‹·è´ä»£ç  ----------
COPY pyproject.toml ./
COPY rag ./rag
COPY infra ./infra
COPY requirements.txt ./requirements.txt
COPY .env.example ./

# ---------- å®‰è£…ä¾èµ– ----------
RUN pip install --upgrade pip setuptools wheel \
 && pip install --no-warn-script-location -r requirements.txt

# ---------- å¯åŠ¨å‰åˆå§‹åŒ–è„šæœ¬ ----------
# åˆ›å»ºå…¥å£è„šæœ¬
RUN echo '#!/usr/bin/env bash\n' \
         'set -e\n' \
         'echo "ğŸ”§ åˆå§‹åŒ– JD collection..."\n' \
         'python infra/scripts/init_weaviate_jd.py || echo "âš ï¸ åˆå§‹åŒ–å¤±è´¥æˆ–å·²å­˜åœ¨ï¼Œç»§ç»­å¯åŠ¨"\n' \
         'echo "ğŸš€ å¯åŠ¨ FastAPI æœåŠ¡..."\n' \
         'exec uvicorn rag.api.main:app --host 0.0.0.0 --port ${PORT:-8001}\n' \
    > /app/entrypoint.sh \
 && chmod +x /app/entrypoint.sh

EXPOSE 8001

# ---------- å¯åŠ¨ ----------
CMD ["/app/entrypoint.sh"]
